{"version":3,"sources":["../../src/classes/Agent.js"],"names":["log","Logger","child","namespace","requestId","Agent","constructor","isProxyConfigured","mustUrlUseProxy","getUrlProxy","fallbackAgent","eventEmitter","addRequest","request","configuration","requestUrl","protocol","hostname","host","port","path","trace","destination","currentRequestId","proxy","authorization","setHeader","Buffer","from","toString","emit","once","response","headers","statusCode","shouldKeepAlive","connectionConfiguration","createConnection","error","socket","onSocket"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport Logger from '../Logger';\nimport type {\n  AgentType,\n  GetUrlProxyMethodType,\n  IsProxyConfiguredMethodType,\n  MustUrlUseProxyMethodType,\n  ProtocolType\n} from '../types';\n\nconst log = Logger.child({\n  namespace: 'Agent'\n});\n\nlet requestId = 0;\n\nclass Agent {\n  defaultPort: number;\n\n  protocol: ProtocolType;\n\n  fallbackAgent: AgentType;\n\n  isProxyConfigured: IsProxyConfiguredMethodType;\n\n  mustUrlUseProxy: MustUrlUseProxyMethodType;\n\n  getUrlProxy: GetUrlProxyMethodType;\n\n  eventEmitter: EventEmitter;\n\n  constructor (\n    isProxyConfigured: IsProxyConfiguredMethodType,\n    mustUrlUseProxy: MustUrlUseProxyMethodType,\n    getUrlProxy: GetUrlProxyMethodType,\n    fallbackAgent: AgentType,\n    eventEmitter: EventEmitter\n  ) {\n    this.fallbackAgent = fallbackAgent;\n    this.isProxyConfigured = isProxyConfigured;\n    this.mustUrlUseProxy = mustUrlUseProxy;\n    this.getUrlProxy = getUrlProxy;\n    this.eventEmitter = eventEmitter;\n  }\n\n  addRequest (request: *, configuration: *) {\n    const requestUrl = this.protocol + '//' + (configuration.hostname || configuration.host) + (configuration.port === 80 || configuration.port === 443 ? '' : ':' + configuration.port) + request.path;\n\n    if (!this.isProxyConfigured()) {\n      log.trace({\n        destination: requestUrl\n      }, 'not proxying request; GLOBAL_AGENT.HTTP_PROXY is not configured');\n\n      // $FlowFixMe It appears that Flow is missing the method description.\n      this.fallbackAgent.addRequest(request, configuration);\n\n      return;\n    }\n\n    if (!this.mustUrlUseProxy(requestUrl)) {\n      log.trace({\n        destination: requestUrl\n      }, 'not proxying request; url matches GLOBAL_AGENT.NO_PROXY');\n\n      // $FlowFixMe It appears that Flow is missing the method description.\n      this.fallbackAgent.addRequest(request, configuration);\n\n      return;\n    }\n\n    const currentRequestId = requestId++;\n\n    const proxy = this.getUrlProxy(requestUrl);\n\n    if (this.protocol === 'http:') {\n      request.path = requestUrl;\n\n      if (proxy.authorization) {\n        request.setHeader('Proxy-Authorization', 'Basic ' + Buffer.from(proxy.authorization).toString('base64'));\n      }\n    }\n\n    this.eventEmitter.emit('request', request);\n\n    log.trace({\n      destination: requestUrl,\n      proxy: 'http://' + proxy.hostname + ':' + proxy.port,\n      requestId: currentRequestId\n    }, 'proxying request');\n\n    request.once('response', (response) => {\n      log.trace({\n        headers: response.headers,\n        requestId: currentRequestId,\n        statusCode: response.statusCode\n      }, 'proxying response');\n    });\n\n    request.shouldKeepAlive = false;\n\n    const connectionConfiguration = {\n      host: configuration.hostname || configuration.host,\n      port: configuration.port || 80,\n      proxy\n    };\n\n    // $FlowFixMe It appears that Flow is missing the method description.\n    this.createConnection(connectionConfiguration, (error, socket) => {\n      if (error) {\n        request.emit('error', error);\n      } else {\n        request.onSocket(socket);\n      }\n    });\n  }\n}\n\nexport default Agent;\n"],"file":"Agent.js"}